<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus & Flow</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font: Press Start 2P -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.6s ease-out forwards;
        }
        /* Custom number input styling */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* Hide scrollbar but keep functionality */
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;
            scrollbar-width: none; 
        }
    </style>
</head>
<body class="bg-black text-white h-screen w-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Inline Icons ---
        const IconWrapper = ({ children, size = 24, className = "", onClick }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
                onClick={onClick}
                style={{ cursor: onClick ? 'pointer' : 'default' }}
            >
                {children}
            </svg>
        );

        const Play = (props) => <IconWrapper {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconWrapper>;
        const Pause = (props) => <IconWrapper {...props}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></IconWrapper>;
        const CheckCircle = (props) => <IconWrapper {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconWrapper>;
        const AlertCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></IconWrapper>;
        const ExternalLink = (props) => <IconWrapper {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></IconWrapper>;
        const Droplet = (props) => <IconWrapper {...props}><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></IconWrapper>;

        // --- App Data ---
        const QUOTES = [
            "The only way to do great work is to love what you do.",
            "Focus on being productive instead of busy.",
            "Your future is created by what you do today, not tomorrow.",
            "Starve your distractions, feed your focus.",
            "One thing at a time. Most important thing first.",
            "Simplicity is the ultimate sophistication."
        ];

        const BACKGROUNDS = {
            morning: "https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?q=100&w=2070&auto=format&fit=crop",
            afternoon: "https://images.unsplash.com/photo-1518173946687-a4c8892bbd9f?q=100&w=1974&auto=format&fit=crop",
            evening: "https://images.unsplash.com/photo-1472120435266-53112dc2de39?q=100&w=1974&auto=format&fit=crop",
            night: "https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?q=100&w=2013&auto=format&fit=crop",
            break: "images/themes/pixel/hero_vs_dragon/winning.png"
        };

        const THEME_BACKGROUNDS = {
            dragon_initial: 'images/themes/pixel/hero_vs_dragon/background.png',
            dragon_phase1: 'images/themes/pixel/hero_vs_dragon/blocking.png',
            dragon_phase2: 'images/themes/pixel/hero_vs_dragon/attacking.png',
            dragon_phase3: 'images/themes/pixel/hero_vs_dragon/winning.png'
        };

        // --- Timer Component ---
        const TimerDisplay = ({ style, timeLeft, duration, mode, setBgImage }) => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeStr = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

            // --- DRAGON'S DEMISE STYLE ---
            const DragonDemiseDisplay = () => {
                const elapsed = duration - timeLeft;
                const progress = duration > 0 ? (elapsed / duration) * 100 : 0;

                let phase = 1;
                if (timeLeft <= 0) phase = 3;
                else if (progress >= 90) phase = 2;

                 useEffect(() => {
                    if (phase === 3) setBgImage(THEME_BACKGROUNDS.dragon_phase3);
                    else if (phase === 2) setBgImage(THEME_BACKGROUNDS.dragon_phase2);
                    else setBgImage(THEME_BACKGROUNDS.dragon_phase1);
                }, [phase]);

                if (phase === 3) {
                    return (
                        <div className="flex flex-col items-center justify-center text-center" style={{ fontFamily: '"Press Start 2P", monospace' }}>
                            <h1 className="text-6xl md:text-8xl text-amber-400 drop-shadow-[6px_6px_0_rgba(0,0,0,1)]">VICTORY!</h1>
                            <p className="text-xl md:text-2xl mt-6 text-white drop-shadow-[3px_3px_0_rgba(0,0,0,1)]">Time for a well-earned break.</p>
                        </div>
                    );
                }

                return (
                    <div className="w-full h-full flex flex-col justify-center items-center" style={{ fontFamily: '"Press Start 2P", monospace' }}>
                        <div className="text-6xl md:text-8xl text-white drop-shadow-[4px_4px_0_rgba(0,0,0,1)] tracking-widest">
                            {timeStr}
                        </div>
                    </div>
                );
            };
            return <DragonDemiseDisplay />;
        };

        // --- Health Bar Component ---
        const HealthBar = ({ percentage, label }) => {
            const barColor = percentage > 50 ? 'bg-green-500' : percentage > 20 ? 'bg-yellow-500' : 'bg-red-500';
            return (
                <div className="w-32 md:w-48 h-4 border-2 border-white bg-gray-800 relative shadow-lg mt-4">
                    <div className={`h-full ${barColor} transition-all duration-500`} style={{ width: `${percentage}%` }}></div>
                    <div className="absolute -top-5 text-xs uppercase tracking-widest">{label}</div>
                </div>
            );
        };

        // --- Main Component ---
        function FocusApp() {
            // --- State ---
            const [mode, setMode] = useState('setup');
            const [task, setTask] = useState('');
            const [duration, setDuration] = useState(25 * 60); 
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [bgImage, setBgImage] = useState(BACKGROUNDS.morning);
            const [quote, setQuote] = useState(QUOTES[0]);
            
            // Custom Time State
            const [customMins, setCustomMins] = useState('');

            // Timer Design State
            const [timerStyle, setTimerStyle] = useState('dragon');
            const [isBlurred, setIsBlurred] = useState(false); // New Blur State

            // Focus Guard State
            const [wasPausedByHide, setWasPausedByHide] = useState(false);
            
            // --- Refs ---
            const timerRef = useRef(null);
            const isActiveRef = useRef(isActive); 

            // --- Effects ---
            
            // Sync ref with state
            useEffect(() => {
                isActiveRef.current = isActive;
            }, [isActive]);

            // Background Logic: Respond to Time OR Style
            useEffect(() => {
                const updateBackground = () => {
                    // 1. Check for specific style overrides first
                   if (timerStyle === 'dragon') {
                       setBgImage(THEME_BACKGROUNDS.dragon_initial);
                       return;
                   }

                    // 2. Fallback to Mode/Time based (Minimal Style)
                    if (mode === 'break') {
                        setBgImage(BACKGROUNDS.break);
                    } else {
                        const hour = new Date().getHours();
                        if (hour < 12) setBgImage(BACKGROUNDS.morning);
                        else if (hour < 17) setBgImage(BACKGROUNDS.afternoon);
                        else if (hour < 20) setBgImage(BACKGROUNDS.evening);
                        else setBgImage(BACKGROUNDS.night);
                    }
                };
                
                updateBackground();
                
                // Set random quote only on mount (not on style change)
            }, [timerStyle, mode]);

            // Initial Mount Quote
            useEffect(() => {
                 const randomQuote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
                 setQuote(randomQuote);
            }, []);

            useEffect(() => {
                if (isActive && timeLeft > 0) {
                    timerRef.current = setInterval(() => {
                        setTimeLeft((prev) => prev - 1);
                    }, 1000);
                } else if (timeLeft === 0) {
                    handleTimerComplete();
                }
                return () => clearInterval(timerRef.current);
            }, [isActive, timeLeft]);

            // Visibility Tracking
            useEffect(() => {
                const handleVisibilityChange = () => {
                    if (document.hidden && isActiveRef.current) {
                        // Pause Logic
                        setIsActive(false);
                        setWasPausedByHide(true);
                        document.title = "‚ö†Ô∏è Come back!";
                        
                        // Play Alert Sound
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(440, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                        osc.start();
                        osc.stop(ctx.currentTime + 0.5);

                        setTimeout(() => {
                            alert("‚ö†Ô∏è Distraction Detected!\n\nYou left the focus zone. Timer paused. Get back to work!");
                        }, 100);

                    } else {
                        if (!document.hidden) {
                            document.title = "Focus & Flow";
                        }
                    }
                };
                
                document.addEventListener("visibilitychange", handleVisibilityChange);
                return () => document.removeEventListener("visibilitychange", handleVisibilityChange);
            }, []); 

            useEffect(() => {
                if (!document.hidden) {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    const timeString = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    document.title = `${timeString} - ${mode === 'break' ? 'Break' : 'Focus'}`;
                }
            }, [timeLeft, mode]);

            // --- Handlers ---
            const handleStartFocus = async () => {
                if ("Notification" in window && Notification.permission !== "granted") {
                    try {
                        await Notification.requestPermission();
                    } catch (e) { console.log(e); }
                }

                setMode('focus');
                setTimeLeft(duration);
                setIsActive(true);
            };

            const handleTimerComplete = () => {
                setIsActive(false);
                clearInterval(timerRef.current);
                
                // Success Beep
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                osc.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.2);

                if (Notification.permission === "granted") {
                    new Notification(mode === 'focus' ? "Focus Session Complete!" : "Break Over!", {
                        body: mode === 'focus' ? "Time to take a break." : "Ready to focus again?",
                    });
                }

                if (mode === 'focus') {
                    setMode('break');
                    setDuration(5 * 60);
                    setTimeLeft(5 * 60);
                    // Force background refresh to break mode if using minimal style
                    if (timerStyle === 'minimal') setBgImage(BACKGROUNDS.break);
                } else {
                    setMode('setup');
                }
            };

            const handleResume = () => {
                setIsActive(true);
                setWasPausedByHide(false);
            };


            const elapsed = duration - timeLeft;
            const progress = duration > 0 ? (elapsed / duration) * 100 : 0;
            let heroHealth = 100;
            let dragonHealth = 100;

            if (timeLeft <= 0) {
                heroHealth = 10;
                dragonHealth = 0;
            } else if (progress >= 90) {
                heroHealth = 10;
                const phaseProgress = (progress - 90) / 10;
                dragonHealth = 100 * (1 - phaseProgress);
            } else {
                const phaseProgress = progress / 90;
                heroHealth = 100 - (90 * phaseProgress);
            }

            return (
                <div className="relative min-h-screen w-full text-white overflow-hidden">
                    
                    {/* Background Layer (Separated for Blur Effect) */}
                    <div
                        className={`absolute inset-0 transition-all duration-1000 transform ${isBlurred ? 'blur-md scale-105' : 'blur-0 scale-100'}`}
                        style={{
                            backgroundImage: `url(${bgImage})`,
                            backgroundSize: 'cover',
                            backgroundPosition: 'center'
                        }}
                    ></div>
                    
                    {/* Dark Overlay */}
                    <div className={`absolute inset-0 bg-black transition-opacity duration-1000 ${mode === 'focus' ? 'bg-opacity-60' : 'bg-opacity-40'}`}></div>

                    {/* Main UI */}
                    <div className="relative z-10 flex flex-col items-center justify-between min-h-screen p-8">
                        
                        {/* Top Bar */}
                        <div className="w-full flex justify-between items-start">
                            <div className="flex flex-col items-start" style={{ fontFamily: '"Press Start 2P", monospace' }}>
                                <div className="flex items-center gap-2 font-semibold tracking-widest text-sm uppercase opacity-80">
                                    <CheckCircle size={18} />
                                    <span>Focus & Flow</span>
                                </div>
                                {timerStyle === 'dragon' && mode === 'focus' && <HealthBar percentage={heroHealth} label="Hero HP" />}
                            </div>
                            
                            <div className="flex flex-col items-end" style={{ fontFamily: '"Press Start 2P", monospace' }}>
                                <a
                                    href="https://mynoise.net/NoiseMachines/rainNoiseGenerator.php"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="flex items-center gap-2 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-full px-4 py-2 transition-all text-sm font-medium border border-white/10"
                                >
                                    <span>Open MyNoise üåßÔ∏è</span>
                                    <ExternalLink size={14} className="opacity-70" />
                                </a>
                                {timerStyle === 'dragon' && mode === 'focus' && <HealthBar percentage={dragonHealth} label="Dragon HP" />}
                            </div>
                        </div>

                        {/* Central Content */}
                        <div className="flex flex-col items-center justify-center w-full max-w-2xl text-center">
                        
                        {mode === 'setup' && (
                            <div className="animate-fade-in flex flex-col items-center gap-8 w-full">
                            <h1 className="text-4xl md:text-5xl font-light mb-4 drop-shadow-lg">What is your main focus?</h1>
                            
                            <input 
                                type="text" 
                                value={task}
                                onChange={(e) => setTask(e.target.value)}
                                placeholder="e.g., Finish the report" 
                                className="w-full bg-transparent border-b-2 border-white/30 text-center text-3xl md:text-4xl py-4 focus:outline-none focus:border-white transition-colors placeholder-white/30 font-light text-white"
                                autoFocus
                            />

                            {/* Time Selection */}
                            <div className="flex flex-wrap justify-center gap-4 mt-6 items-center">
                                {[25, 45, 60].map((mins) => (
                                    <button 
                                        key={mins}
                                        onClick={() => {
                                            setDuration(mins * 60);
                                            setCustomMins('');
                                        }}
                                        className={`px-6 py-3 rounded-full border border-white/20 hover:bg-white/10 transition-all ${duration === mins * 60 && customMins === '' ? 'bg-white text-black hover:bg-white' : ''}`}
                                    >
                                        {mins}m
                                    </button>
                                ))}
                                
                                <div className="relative group">
                                    <input 
                                        type="number" 
                                        placeholder="Custom"
                                        min="1"
                                        value={customMins}
                                        onChange={(e) => {
                                            const val = e.target.value;
                                            setCustomMins(val);
                                            if (val > 0) setDuration(val * 60);
                                        }}
                                        className={`w-28 bg-transparent border rounded-full px-4 py-3 text-center focus:outline-none focus:border-white transition-colors ${customMins !== '' ? 'border-white bg-white/10' : 'border-white/20'}`}
                                    />
                                    <span className="absolute right-3 top-1/2 -translate-y-1/2 text-xs opacity-50 pointer-events-none">m</span>
                                </div>
                            </div>


                            <button 
                                onClick={handleStartFocus}
                                disabled={!task}
                                className="mt-8 group flex items-center gap-3 bg-white text-black px-8 py-4 rounded-full text-xl font-medium hover:scale-105 transition-transform disabled:opacity-50 disabled:hover:scale-100"
                            >
                                Start Focus <Play size={20} className="fill-current" />
                            </button>
                            </div>
                        )}

                        {mode !== 'setup' && (
                            <div className="animate-fade-in flex flex-col items-center gap-6">
                            <div className="text-sm uppercase tracking-[0.3em] opacity-80 mb-4">
                                {mode === 'focus' ? 'Focus Mode' : 'Break Time'}
                            </div>

                            {/* Render Timer based on Style */}
                            <TimerDisplay style={timerStyle} timeLeft={timeLeft} duration={duration} mode={mode} setBgImage={setBgImage} />

                            <div className="text-2xl md:text-3xl font-light opacity-90 max-w-xl break-words mt-4">
                                {mode === 'focus' ? task : "Take a deep breath."}
                            </div>

                            <div className="flex items-center gap-6 mt-12">
                                <button 
                                    onClick={() => setIsActive(!isActive)}
                                    className="p-4 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-sm transition-all border border-white/10"
                                >
                                    {isActive ? <Pause size={32} /> : <Play size={32} className="ml-1" />}
                                </button>
                                
                                {mode === 'focus' ? (
                                    <button 
                                        onClick={handleTimerComplete}
                                        className="px-6 py-3 rounded-full border border-white/20 hover:bg-white/10 text-sm font-medium tracking-wide"
                                    >
                                        FINISH EARLY
                                    </button>
                                ) : (
                                    <button 
                                        onClick={() => {
                                            setMode('setup');
                                            setIsActive(false);
                                            setTask('');
                                        }}
                                        className="px-6 py-3 rounded-full border border-white/20 hover:bg-white/10 text-sm font-medium tracking-wide"
                                    >
                                        NEW SESSION
                                    </button>
                                )}
                            </div>
                            </div>
                        )}

                        {/* Penalty Modal */}
                        {wasPausedByHide && !isActive && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md animate-fade-in">
                                <div className="bg-white/10 border border-white/20 p-8 rounded-2xl max-w-md text-center shadow-2xl">
                                    <AlertCircle size={48} className="mx-auto text-amber-400 mb-4" />
                                    <h2 className="text-2xl font-bold mb-2">Distraction Detected!</h2>
                                    <p className="opacity-80 mb-6">You left the focus window. The timer was paused to help you stay disciplined.</p>
                                    <button 
                                        onClick={handleResume}
                                        className="bg-white text-black px-8 py-3 rounded-full font-medium hover:scale-105 transition-transform"
                                    >
                                        Resume Session
                                    </button>
                                </div>
                            </div>
                        )}

                        </div>

                        {/* Bottom Right Floating Controls */}
                        <div className="absolute bottom-8 right-8 z-40 flex gap-4">
                            {/* Blur Toggle (Always visible) */}
                            <button 
                                onClick={() => setIsBlurred(!isBlurred)}
                                className={`bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-full p-4 transition-all shadow-lg hover:scale-105 border border-white/10 group ${isBlurred ? 'bg-white/30 border-white' : ''}`}
                                title="Toggle Blur"
                            >
                                <Droplet size={24} className={`opacity-70 group-hover:opacity-100 ${isBlurred ? 'fill-current' : ''}`} />
                            </button>

                        </div>

                        {/* Bottom Bar (Quote) */}
                        <div className="w-full flex justify-center items-end h-20">
                            <div className="text-center max-w-lg">
                                <p className="text-lg italic font-light drop-shadow-md">"{quote}"</p>
                            </div>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FocusApp />);
    </script>
</body>
</html>